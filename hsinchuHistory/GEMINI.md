# 時間軸事件地圖系統規格文件（spec.md）

## 1. 系統概要
本系統為一個基於 Leaflet 的互動地圖應用，支援多種地圖圖層（地形圖、衛星圖、道路圖）切換，並在地圖上播放「單一事件」與「持續事件」的時間軸動畫。

系統目標：
- 提供事件資料的空間與時間可視化
- 支援不同事件類型與播放效果
- 支援事件資料庫與地點資料庫分離設計，方便擴展

---

## 2. 功能需求

### 2.1 地圖功能
- 使用 Leaflet 作為地圖渲染引擎
- 支援多圖層切換：
  - **道路地圖**（OSM）
  - **衛星圖**（Esri 或 Google）
  - **地形圖**（OpenTopoMap 或其他免費來源）
- 支援平移、縮放
- 在事件播放時自動平移至事件地點


UI 排版規劃（Tailwind）
兩欄布局

左欄：w-2/3 地圖區

右欄：w-1/3 卡片列表，支援垂直滾動

地圖下方的時間軸

fixed bottom-0 w-full，在遊戲完成後顯示

滑桿可用 <input type="range"> 或自訂樣式的 slider


1. 版型結構（Tailwind + Leaflet）
整體用 左右分欄 + 底部時間軸：

markdown

------------------------------------------------------
| 地圖 (2/3)                | 卡片欄 (1/3)           |
|                           |                       |
|  Leaflet 地圖             |  歷史事件卡片列表       |
|                           |                       |
------------------------------------------------------
|          時間軸 (完成後顯示)                       |
------------------------------------------------------
左欄（地圖）→ w-2/3 h-full，Leaflet 容器

右欄（卡片列表）→ w-1/3 h-full overflow-y-auto，HTML5 拖放事件

時間軸 → fixed bottom-0 w-full，初始隱藏，完成後顯示

2. 可能點位（吸附目標）資料結構
這些是地圖上「可以放卡片的正確地點」，一開始就要建立好（類似一個「答案資料庫」），原因：

拖放時才能即時計算距離判斷是否吸附

時間軸播放時才能根據這些點位顯示事件



### 2.2 資料庫結構

#### 2.2.1 地點資料庫（`locations`）
| 欄位        | 型別       | 說明 |
|-------------|-----------|------|
| `location_id` | string  | 地點唯一 ID |
| `name`        | string  | 地點名稱 |
| `lat`         | float   | 緯度 |
| `lng`         | float   | 經度 |
| `radius`      | int     | 範圍 |
| `description` | string? | 描述（可選） |

radius 用來判斷「拖曳物件是否接近」的距離範圍（Leaflet 有 map.distance(latlng1, latlng2) 可計算公尺距離）

#### 2.2.2 事件資料庫（`events`）
支援 **單一事件** 與 **持續事件**：
| 欄位        | 型別       | 說明 |
|-------------|-----------|------|
| `event_id`   | string  | 事件唯一 ID |
| `title`      | string  | 事件標題 |
| `location_id`| string  | 對應 `locations.location_id` |
| `event_type` | enum    | `"single"`（單一事件）或 `"continuous"`（持續事件） |
| `start_time` | datetime | 事件開始時間 |
| `end_time`   | datetime? | 事件結束時間（持續事件才有） |
| `description`| string? | 事件描述（可選） |
| `icon`       | string? | 自訂事件圖示（可選） |
| `color`      | string? | 標記顏色（可選） |



---

## 自動吸附的原理
玩家拖卡片到地圖上，當拖曳的游標座標轉成地圖經緯度後：
檢查與所有 possiblePoints 的距離
找到最近的點，如果距離小於 radius → 自動吸附（卡片標記直接貼在該點）

吸附後：
卡片與該點綁定
該點標記為已完成（可變色、加 icon）


5. 遊戲流程（整合吸附 + 資料結構）
初始化 Leaflet 地圖與 possiblePoints
畫出這些點位（初期可隱藏或用半透明圈表示吸附範圍，方便測試）
玩家拖曳卡片 → 轉換位置為經緯度 → 判斷距離最近的 possiblePoint
符合距離 → 吸附 → 綁定事件 → 更新 UI
所有卡片完成 → 顯示時間軸模式

## 3. 時間軸播放功能
 關聯關係
一對多：
locations（地點） ⟶ events（多個事件）
例：station 地點有 1913 落成、2010 改建等事件

遊戲邏輯：

拖放時，檢查卡片的 locationId 是否與吸附到的 locations.id 相同

時間軸播放時，依事件的 year 排序，在對應的地點顯示

### 3.1 播放模式
- **單一事件（single）**
  - 在時間軸對應時間點，地圖上於事件位置顯示「標記閃爍」
  - 停留時間可設定（預設 3 秒）
- **持續事件（continuous）**
  - 在事件持續期間內，地圖標記會常駐並高亮
  - 播放進度條顯示事件開始到結束的範圍
  - 可用「淡入」進入、「淡出」結束

### 3.2 播放控制
- 播放 / 暫停 / 停止
- 時間軸滑桿可拖曳到任意時間
- 播放速度調整（例如 1x, 2x, 5x）

---

## 4. 技術規格

### 4.1 前端
- **框架**：Vanilla JS 或任意框架（依需求）
- **地圖**：Leaflet + 多圖層來源
- **UI**：時間軸控制器、地圖圖層切換控制器

### 4.2 資料格式
所有資料使用 JSON，檔案在`data.json`


AI Agent 任務分解與開發提示文件

1. 系統目標 

建立一個支援 單一事件 與 持續事件 的互動時間軸播放系統，資料來源包含：

- 事件資料庫（事件內容、時間範圍、對應地點 ID）
- 地點資料庫（地點資訊、座標）

並在時間軸播放時，根據事件資料，動態在地圖或畫面上顯示事件動畫效果。

2. 任務分解
任務 A — 資料結構建立
- 設計事件資料庫結構，支援：
    - 單一事件（single）
    - 持續事件（duration）
- 設計地點資料庫結構，支援：
    - 地點名稱、經緯度


任務 B — 播放邏輯設計
- 時間軸控制器
    - 接收「播放時間」與「播放速度」
    - 動態篩選該時間點應顯示的事件

- 事件觸發判斷
    - 單一事件：當播放時間 == 事件時間 → 觸發
    - 持續事件：當播放時間介於 startTime 與 endTime → 保持顯示

任務 C — 播放效果（動畫）
    - 單一事件 在地圖上顯示一次性的動畫（例如閃爍、爆炸效果）
    - 持續事件 在地圖上持續顯示圖示，並可加上持續變化（例如顏色漸變、範圍擴散）
    - 支援自訂動畫模板（讓不同事件類型對應不同效果）

任務 D — AI Agent 開發提示
-   Step 1 — 讀取資料
    - 從 events.json 與 locations.json 載入資料
    - 建立 locationId → 座標 的快速查詢表

Step 2 — 時間軸運算
    - 設定播放時間、播放速度（如每秒對應 1 小時的事件）
    - 每次時間更新：
        - 遍歷事件資料庫
        - 判斷哪些事件在當前時間需要觸發或顯示
Step 3 — 動畫管理
    - 對觸發的事件，呼叫對應動畫函數
    - 動畫要能支援：
        - 一次性效果（fireOnce）
        - 持續效果（start/stop）

Step 4 — 渲染輸出
    - 在地圖（Leaflet、Mapbox 或 Three.js）或 Canvas 上繪製動畫
    - 每次時間更新，重新繪製當前事件狀態

3. AI Agent 開發注意事項
    - 資料解耦：事件資料與地點資料分開，靠 locationId 關聯
    - 時間處理統一：全部使用 UTC ISO 格式時間，避免時區錯誤
    - 動畫模板化：不同事件類型應能快速套用不同動畫
    - 效能：持續事件要避免每幀重建動畫，可用狀態保持

4. 產出項目
    - data.json    
    - timeline.js（時間軸播放邏輯）
    - animations.js（動畫效果定義）
    - main.js（整合播放邏輯與動畫顯示）