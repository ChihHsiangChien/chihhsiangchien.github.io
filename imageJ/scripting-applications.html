<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>scripting-applications</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="toc">
<h2><a href="index.html">主頁</a></h2>

<div class="toc-container">
<div class="toc">
<ul>
<li><a href="#imagej">ImageJ腳本化應用指南</a><ul>
<li><a href="#_1">簡介</a></li>
<li><a href="#_2">基礎腳本編寫</a><ul>
<li><a href="#_3">腳本語言選擇</a></li>
<li><a href="#_4">基本結構</a></li>
</ul>
</li>
<li><a href="#_5">影像分割應用</a><ul>
<li><a href="#_6">自動分割流程</a></li>
<li><a href="#_7">互動式分割</a></li>
</ul>
</li>
<li><a href="#_8">自動計數應用</a><ul>
<li><a href="#_9">細胞計數</a></li>
<li><a href="#_10">群體分析</a></li>
</ul>
</li>
<li><a href="#_11">定量分析</a><ul>
<li><a href="#_12">強度測量</a></li>
<li><a href="#_13">形態測量</a></li>
</ul>
</li>
<li><a href="#_14">批量處理</a><ul>
<li><a href="#_15">文件處理</a></li>
<li><a href="#_16">並行處理</a></li>
</ul>
</li>
<li><a href="#_17">結果管理</a><ul>
<li><a href="#_18">數據導出</a></li>
<li><a href="#_19">結果可視化</a></li>
</ul>
</li>
<li><a href="#_20">最佳實踐</a><ul>
<li><a href="#_21">代碼組織</a></li>
<li><a href="#_22">效能優化</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

</div>
</div>

<div id="content">
<h1 id="imagej">ImageJ腳本化應用指南</h1>
<h2 id="_1">簡介</h2>
<p>ImageJ的腳本化功能允許用戶自動化複雜的影像分析工作流程。本章將介紹如何使用腳本實現各種分析任務，包括分割、計數和定量分析。</p>
<h2 id="_2">基礎腳本編寫</h2>
<h3 id="_3">腳本語言選擇</h3>
<ol>
<li>
<p>ImageJ Macro
   <code>// 基本語法
   run("Command");
   selectWindow("Image");
   setThreshold(0, 255);</code></p>
</li>
<li>
<p>Python (Jython)
   ```python
   from ij import IJ, ImagePlus
   from ij.process import ImageProcessor</p>
</li>
</ol>
<p># 基本操作
   imp = IJ.openImage("sample.tif")
   ip = imp.getProcessor()
   ```</p>
<ol>
<li>JavaScript
   ```javascript
   importClass(Packages.ij.IJ);
   importClass(Packages.ij.ImagePlus);</li>
</ol>
<p>// 基本操作
   var imp = IJ.openImage("sample.tif");
   ```</p>
<h3 id="_4">基本結構</h3>
<ol>
<li>初始化
   ```
   // 設置批處理模式
   setBatchMode(true);</li>
</ol>
<p>// 設置測量參數
   run("Set Measurements...", 
       "area mean standard min centroid perimeter shape feret's integrated display redirect=None decimal=3");
   ```</p>
<ol>
<li>錯誤處理
   ```
   // 錯誤檢查
   if (nImages == 0) {
       exit("No image is open");
   }</li>
</ol>
<p>// 異常捕獲
   try {
       // 處理代碼
   } catch(err) {
       print("Error: " + err);
   }
   ```</p>
<h2 id="_5">影像分割應用</h2>
<h3 id="_6">自動分割流程</h3>
<ol>
<li>
<p>預處理
   ```
   macro "Auto Segmentation" {
       // 背景校正
       run("Subtract Background...", "rolling=50");</p>
<p>// 降噪
   run("Gaussian Blur...", "sigma=2");</p>
<p>// 自動閾值
   setAutoThreshold("Otsu dark");
   run("Convert to Mask");
   }
   ```</p>
</li>
<li>
<p>後處理
   ```
   // 形態學操作
   run("Fill Holes");
   run("Watershed");</p>
</li>
</ol>
<p>// 物件過濾
   run("Analyze Particles...", 
       "size=100-Infinity circularity=0.5-1.00 show=Outlines display exclude clear");
   ```</p>
<h3 id="_7">互動式分割</h3>
<pre><code>macro &quot;Interactive Segmentation&quot; {
    // 用戶選擇ROI
    setTool(&quot;freehand&quot;);
    waitForUser(&quot;Draw ROI around object&quot;);

    // 局部分割
    run(&quot;Clear Outside&quot;);
    setAutoThreshold(&quot;Default&quot;);
    run(&quot;Analyze Particles...&quot;);
}
</code></pre>
<h2 id="_8">自動計數應用</h2>
<h3 id="_9">細胞計數</h3>
<ol>
<li>
<p>基本計數
   ```
   macro "Cell Counter" {
       // 預處理
       run("8-bit");
       run("Enhance Contrast...", "saturated=0.3");</p>
<p>// 分割和計數
   setAutoThreshold("Otsu");
   run("Convert to Mask");
   run("Watershed");
   run("Analyze Particles...", 
       "size=50-500 circularity=0.5-1.00 show=Outlines display clear");
   }
   ```</p>
</li>
<li>
<p>多通道計數
   ```
   macro "Multi-Channel Counter" {
       // 分離通道
       run("Split Channels");</p>
<p>// 處理每個通道
   for (i = 1; i &lt;= 3; i++) {
       selectWindow("C" + i + "-Original");
       // 計數處理
       countObjects();
   }
   }
   ```</p>
</li>
</ol>
<h3 id="_10">群體分析</h3>
<pre><code>function analyzeColonies() {
    // 設置比例尺
    run(&quot;Set Scale...&quot;, &quot;distance=100 known=1 unit=mm&quot;);

    // 分析群體
    run(&quot;Analyze Particles...&quot;, 
        &quot;size=0.1-Infinity circularity=0-1.00 show=Outlines display clear&quot;);

    // 保存結果
    saveAs(&quot;Results&quot;, &quot;colony_analysis.csv&quot;);
}
</code></pre>
<h2 id="_11">定量分析</h2>
<h3 id="_12">強度測量</h3>
<ol>
<li>
<p>ROI分析
   ```
   macro "Intensity Analysis" {
       // 選擇ROI
       roiManager("Reset");
       setTool("rectangle");
       waitForUser("Select regions of interest");</p>
<p>// 測量強度
   for (i = 0; i &lt; roiManager("count"); i++) {
       roiManager("Select", i);
       run("Measure");
   }
   }
   ```</p>
</li>
<li>
<p>時間序列分析
   ```
   macro "Time Series Analysis" {
       // 設置測量
       run("Set Measurements...", "mean standard integrated stack display redirect=None decimal=3");</p>
<p>// 分析每一幀
   for (i = 1; i &lt;= nSlices; i++) {
       setSlice(i);
       run("Measure");
   }
   }
   ```</p>
</li>
</ol>
<h3 id="_13">形態測量</h3>
<pre><code>macro &quot;Morphological Analysis&quot; {
    // 設置測量參數
    run(&quot;Set Measurements...&quot;, 
        &quot;area perimeter shape feret's integrated display redirect=None decimal=3&quot;);

    // 執行分析
    run(&quot;Analyze Particles...&quot;, 
        &quot;size=0-Infinity show=Outlines display clear&quot;);

    // 導出結果
    saveAs(&quot;Results&quot;, &quot;morphology_results.csv&quot;);
}
</code></pre>
<h2 id="_14">批量處理</h2>
<h3 id="_15">文件處理</h3>
<pre><code>macro &quot;Batch Process&quot; {
    input = getDirectory(&quot;Input Directory&quot;);
    output = getDirectory(&quot;Output Directory&quot;);
    files = getFileList(input);

    // 處理每個文件
    for (i = 0; i &lt; files.length; i++) {
        if (endsWith(files[i], &quot;.tif&quot;)) {
            processFile(input + files[i], output);
        }
    }
}

function processFile(input, output) {
    // 打開文件
    open(input);

    // 處理步驟
    run(&quot;Subtract Background...&quot;, &quot;rolling=50&quot;);
    run(&quot;Gaussian Blur...&quot;, &quot;sigma=2&quot;);
    setAutoThreshold(&quot;Otsu&quot;);
    run(&quot;Convert to Mask&quot;);

    // 保存結果
    saveAs(&quot;Tiff&quot;, output + &quot;processed_&quot; + getTitle());
    close();
}
</code></pre>
<h3 id="_16">並行處理</h3>
<pre><code>macro &quot;Parallel Processing&quot; {
    // 設置線程數
    threads = 4;
    files = getFileList(getDirectory(&quot;Input&quot;));
    batchSize = floor(files.length / threads);

    // 分配任務
    for (t = 0; t &lt; threads; t++) {
        startIndex = t * batchSize;
        endIndex = (t == threads-1) ? files.length : (t+1) * batchSize;
        processFileBatch(startIndex, endIndex);
    }
}
</code></pre>
<h2 id="_17">結果管理</h2>
<h3 id="_18">數據導出</h3>
<ol>
<li>表格導出
   ```
   // 保存測量結果
   saveAs("Results", "analysis_results.csv");</li>
</ol>
<p>// 導出ROI
   roiManager("Save", "ROI_set.zip");
   ```</p>
<ol>
<li>圖像導出
   ```
   // 保存處理後的影像
   saveAs("Tiff", "processed_image.tif");</li>
</ol>
<p>// 保存疊加結果
   saveAs("Overlay", "overlay_result.tif");
   ```</p>
<h3 id="_19">結果可視化</h3>
<pre><code>macro &quot;Visualize Results&quot; {
    // 生成直方圖
    run(&quot;Histogram&quot;);

    // 創建圖表
    Plot.create(&quot;Analysis Results&quot;, &quot;Measurement&quot;, &quot;Value&quot;);
    Plot.add(&quot;Circle&quot;, xPoints, yPoints);
    Plot.show();
}
</code></pre>
<h2 id="_20">最佳實踐</h2>
<h3 id="_21">代碼組織</h3>
<ol>
<li>模塊化設計
   ```
   // 主函數
   macro "Main" {
       initialize();
       processImages();
       exportResults();
       cleanup();
   }</li>
</ol>
<p>// 功能模塊
   function initialize() {
       setBatchMode(true);
       run("Set Measurements...");
   }
   ```</p>
<ol>
<li>參數管理
   ```
   // 全局參數
   var THRESHOLD = 128;
   var MIN_SIZE = 50;
   var MAX_SIZE = 500;</li>
</ol>
<p>// 參數配置
   function loadConfig() {
       // 從文件讀取配置
   }
   ```</p>
<h3 id="_22">效能優化</h3>
<ol>
<li>記憶體管理
   ```
   // 定期清理
   run("Collect Garbage");</li>
</ol>
<p>// 關閉未使用的窗口
   if (isOpen("Results")) {
       selectWindow("Results");
       run("Close");
   }
   ```</p>
<ol>
<li>運行時優化
   ```
   // 批處理模式
   setBatchMode(true);</li>
</ol>
<p>// 禁用更新
   setOption("DisablePopupMenu", true);
   ``` </p>
</div>

<!-- 如果需要使用 Mermaid JS，請取消註解以下代碼並確保 Mermaid JS 已正確安裝 -->
<!-- Mermaid 是一個用於生成圖表和流程圖的 JavaScript 庫。 -->
<!-- 官方文件: https://mermaid-js.github.io/mermaid/#/ -->
<script type="module">
  // 初始化 Mermaid JS，啟用自動渲染
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  // 設定 Mermaid 的配置
  mermaid.initialize({
    startOnLoad: true,
    theme: 'neutral',
    flowchart: {
      curve: 'linear'
    },
    sequence: {
      actorFontSize: 16,
      actorMargin: 10,
      boxTextMargin: 6,
      noteMargin: 10,
      messageMargin: 10
    }
  });  

  // 自動渲染所有的 Mermaid 圖表
  mermaid.run({ nodes: document.querySelectorAll('.language-mermaid') });

</script>

</body>
</html>
