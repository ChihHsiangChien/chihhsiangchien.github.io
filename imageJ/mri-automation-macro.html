<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>mri-automation-macro</title>
<link rel="stylesheet" href="styles.css">
<!-- KaTeX CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">
</head>
<body>

<div id="toc">
<h2><a href="index.html">回到首頁</a></h2>
<div class="toc-container">
<div class="toc">
<ul>
<li><a href="#macro">自動化流程：撰寫 Macro 腳本完成端到端分析</a><ul>
<li><a href="#1">1. 分析目標</a></li>
<li><a href="#2-macro">2. 完整 Macro 腳本</a></li>
<li><a href="#3">3. 程式碼解讀</a></li>
<li><a href="#4">4. 如何執行與擴充</a></li>
</ul>
</li>
</ul>
</div>

</div>
</div>
<div id="content">
<h1 id="macro">自動化流程：撰寫 Macro 腳本完成端到端分析</h1>
<p>在科學研究中，<strong>可重複性</strong>和<strong>效率</strong>是至關重要的。手動點擊介面完成分析不僅耗時，而且容易因操作差異引入誤差。ImageJ 的<strong>巨集 (Macro)</strong> 功能允許我們將一系列操作錄製或編寫成腳本，實現一鍵式自動化分析。</p>
<p>本章節將綜合前述教學的知識，提供一個完整的 ImageJ Macro 腳本。這個腳本將自動完成從開啟 <code>t1-header.tif</code> 影像，到分割腦組織與頭骨，再到計算體積的整個端到端 (End-to-End) 流程。</p>
<h2 id="1">1. 分析目標</h2>
<p>我們的目標是撰寫一個 ImageJ Macro 腳本 (<code>.ijm</code> 檔案)，使其能自動執行以下任務：</p>
<ol>
<li>開啟指定的 <code>t1-header.tif</code> 影像。</li>
<li>執行去頭骨 (Skull Stripping) 操作，產生 <code>Brain Mask</code>。</li>
<li>執行頭骨分割操作，產生 <code>Skull Mask</code>。</li>
<li>設定正確的空間校正 (1 x 1 x 1.33 mm)。</li>
<li>分別計算腦組織和頭骨的體積。</li>
<li>將計算結果清晰地顯示在 Log 視窗中。</li>
</ol>
<h2 id="2-macro">2. 完整 Macro 腳本</h2>
<p>您可以將以下程式碼直接複製到 Fiji 的腳本編輯器 (<code>File &gt; New &gt; Script...</code>) 中，並將語言設定為 <code>ImageJ Macro</code>。執行前，請確保 <code>t1-header.tif</code> 檔案位於 ImageJ/Fiji 可以存取的位置（例如，放在 Fiji 的 <code>samples</code> 資料夾內，或在程式碼中指定完整路徑）。</p>
<pre><code class="language-ijm">/*
 * Macro: End-to-End MRI Brain Segmentation and Volume Analysis
 * Author: Gemini Code Assist
 * Date: 2023-10-27
 * Description: This macro automates the segmentation of brain and skull 
 *              from the t1-header.tif sample image and calculates their volumes.
 */

// --- 1. Setup and Open Image ---
requires(&quot;1.53t&quot;); // Require a recent version of ImageJ
print(&quot;\\Clear&quot;); // Clear the log window
print(&quot;--- Starting MRI Analysis Workflow ---&quot;);

// Open the sample image. Replace with open(&quot;/path/to/your/t1-header.tif&quot;); for other locations.
run(&quot;T1 Head (2.4M, 16-bits)&quot;); 
original_title = getTitle();

// --- 2. Brain Segmentation (Skull Stripping) ---
print(&quot;Step 1: Segmenting Brain...&quot;);
run(&quot;Duplicate...&quot;, &quot;title=temp_brain&quot;);
setAutoThreshold(&quot;Default&quot;);
run(&quot;Convert to Mask&quot;, &quot;method=Default background=Dark&quot;);
run(&quot;Fill Holes&quot;);
run(&quot;Analyze Particles...&quot;, &quot;size=5000-Infinity display clear record add&quot;);
// The largest particle is now in the ROI Manager
roiManager(&quot;Select&quot;, 0);
run(&quot;Create Mask&quot;);
brain_mask_title = getTitle();
rename(&quot;Brain_Mask&quot;);
print(&quot;Brain Mask created.&quot;);
roiManager(&quot;Deselect&quot;);
roiManager(&quot;Delete&quot;);

// --- 3. Skull Segmentation ---
print(&quot;Step 2: Segmenting Skull...&quot;);
selectWindow(original_title);
run(&quot;Duplicate...&quot;, &quot;title=Head_Mask&quot;);
setAutoThreshold(&quot;Default&quot;);
setThreshold(1, 65535); // Threshold for all non-black pixels
run(&quot;Convert to Mask&quot;, &quot;method=Default background=Dark&quot;);
imageCalculator(&quot;Subtract create stack&quot;, &quot;Head_Mask&quot;, &quot;Brain_Mask&quot;);
selectWindow(&quot;Result of Head_Mask&quot;);
rename(&quot;Skull_Mask&quot;);
print(&quot;Skull Mask created.&quot;);
close(&quot;Head_Mask&quot;);

// --- 4. Volume Calculation ---
print(&quot;Step 3: Calculating Volumes...&quot;);
// Set Scale
run(&quot;Set Scale...&quot;, &quot;distance=1 known=1 pixel=1 unit=mm&quot;);
run(&quot;Properties...&quot;, &quot;channels=1 slices=129 frames=1 unit=mm pixel_width=1.0 pixel_height=1.0 voxel_depth=1.33&quot;);

// Calculate Brain Volume
selectWindow(&quot;Brain_Mask&quot;);
run(&quot;3D Object Counter&quot;, &quot;threshold=128 min=1000 summary&quot;);
brain_volume = getResult(&quot;Volume&quot;, 0);

// Calculate Skull Volume
selectWindow(&quot;Skull_Mask&quot;);
run(&quot;3D Object Counter&quot;, &quot;threshold=128 min=1000 summary&quot;);
skull_volume = getResult(&quot;Volume&quot;, 0);

// --- 5. Display Results ---
print(&quot;\\n--- Analysis Complete ---&quot;);
print(&quot;Brain Volume: &quot; + brain_volume + &quot; mm^3 (&quot; + brain_volume/1000 + &quot; cm^3)&quot;);
print(&quot;Skull Volume: &quot; + skull_volume + &quot; mm^3 (&quot; + skull_volume/1000 + &quot; cm^3)&quot;);
print(&quot;-------------------------&quot;);
run(&quot;Close All&quot;); // Clean up all windows

</code></pre>
<h2 id="3">3. 程式碼解讀</h2>
<ul>
<li><strong><code>print("\\Clear");</code></strong>: 清空日誌視窗，方便查看本次執行的輸出。</li>
<li><strong><code>run("T1 Head (2.4M, 16-bits)");</code></strong>: 開啟內建範例影像。如果您的檔案在其他地方，請用 <code>open("C:/path/to/your/file.tif");</code>。</li>
<li><strong><code>setAutoThreshold("Default");</code></strong>: 自動設定閾值。</li>
<li><strong><code>run("Convert to Mask", ...);</code></strong>: 將閾值選擇應用於影像，產生二值化遮罩。</li>
<li><strong><code>run("Fill Holes");</code></strong>: 執行形態學的填補孔洞操作。</li>
<li><strong><code>run("Analyze Particles...", "...add");</code></strong>: 這是去頭骨的關鍵。我們不直接產生遮罩，而是利用粒子分析找到最大的物件（大腦），並將其輪廓加入到 ROI 管理器中。</li>
<li><strong><code>roiManager("Select", 0); run("Create Mask");</code></strong>: 選取 ROI 管理器中的第一個（也是唯一一個）ROI，並根據它產生一個精確的腦部遮罩。</li>
<li><strong><code>imageCalculator("Subtract create stack", ...);</code></strong>: 執行影像計算，從「整個頭部」減去「腦部」，得到頭骨。</li>
<li><strong><code>run("Properties...", ...);</code></strong>: 設定影像的空間校正參數。</li>
<li><strong><code>run("3D Object Counter", ...);</code></strong>: 執行 3D 分析並計算體積。<code>summary</code> 參數會自動將結果顯示在預設的 Results 表格中。</li>
<li><strong><code>getResult("Volume", 0);</code></strong>: 從 Results 表格的第一行 (<code>0</code>) 讀取 <code>Volume</code> 欄位的值，並存入變數。</li>
<li><strong><code>run("Close All");</code></strong>: 腳本執行完畢後，關閉所有開啟的視窗，保持工作區乾淨。</li>
</ul>
<h2 id="4">4. 如何執行與擴充</h2>
<ul>
<li><strong>執行腳本：</strong> 在腳本編輯器視窗中，點擊 <code>Run</code> 按鈕。觀察 Log 視窗 (<code>Window &gt; Log</code>) 的即時輸出。</li>
<li><strong>擴充應用：</strong> 這個腳本是自動化分析的基礎。您可以輕易地擴充它，例如：<ul>
<li>將其放入 <code>Process &gt; Batch &gt; Macro...</code> 中，對整個資料夾的 MRI 影像進行批次處理。</li>
<li>加入 <code>saveAs("Tiff", ...)</code> 指令，將產生的 <code>Brain_Mask</code> 和 <code>Skull_Mask</code> 自動儲存到指定資料夾。</li>
<li>將計算出的體積寫入一個 CSV 檔案，方便後續的統計分析。</li>
</ul>
</li>
</ul>
</div>

<!-- Mermaid JS -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({}); // Keep double braces for literal JS object
  mermaid.run({ nodes: document.querySelectorAll('.language-mermaid') }); // Keep double braces
</script>

<!-- KaTeX JS -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"></script>
<!-- *** CORRECTED SCRIPT WITH ${...} ESCAPING *** -->
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                renderMathInElement(document.body, {
                    delimiters: [
                        { left: '$$',  right: '$$',  display: true },
                        { left: '\\[', right: '\\]', display: true },
                        { left: '\\(', right: '\\)', display: false }
                    ],
                    ignoredTags: ['script','noscript','style','textarea','pre','code'],
                    throwOnError: false
                });
            });
        </script>

</body>
</html>
