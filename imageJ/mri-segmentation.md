# 使用 t1-header.tif 進行 MRI 影像分割：分離頭骨與腦組織

本章節將以 `t1-header.tif` 這組 T1 加權的腦部 MRI 影像為範例，學習如何使用 ImageJ/Fiji 進行基礎的影像分割，將感興趣的解剖結構，如腦組織（Brain）和頭骨（Skull），分離出來，並進行 3D 視覺化呈現。

這項技術是醫學影像分析的基礎，對於體積計算、形態學研究和手術規劃至關重要。

## 1. 案例介紹與準備工作

### 認識範例影像 `t1-header.tif`

這是一套包含 129 張連續切片的 T1 加權 MRI 影像堆疊（Image Stack）。

-   **資料來源:** Jeff Orchard, University of Waterloo.
-   **影像特性:**
    -   在 T1 加權影像中，不同組織的對比度良好。一般來說，脂肪（如骨髓）呈現高訊號（亮色），腦白質比腦灰質亮，而腦脊髓液（CSF）則呈現低訊號（暗色）。
    -   影像背景（頭部以外的區域）已被設為零，方便我們進行分析。

### 分析目標

1.  從影像中分離出**腦組織**。
2.  分離出**頭骨**結構。
3.  將分離出的結構進行 **3D 視覺化**。

### 操作前的建議

1.  **開啟影像：** 直接將 `t1-header.tif` 檔案拖曳至 Fiji/ImageJ 視窗，或使用 `File > Open...`。
2.  **探索影像堆疊：**
    -   使用視窗下方的滑桿，可以瀏覽不同的 Z 軸切片。
    -   執行 `Image > Stacks > Orthogonal Views` 可以同時從三個正交平面（橫斷面、冠狀面、矢狀面）觀察影像，這對於理解 3D 結構非常有幫助。

## 2. 步驟一：分離腦組織 (Brain Extraction / Skull Stripping)
### 方法一：基於閾值的分割 (快速但可能不準確)
我們的第一個目標是建立一個只包含腦組織的**二值化遮罩 (Binary Mask)**。

1.  **影像複製與轉換：**
    *   為保留原始數據，先複製一份影像：`Image > Duplicate...`，並將新影像命名為 `Brain Mask`。
    *   請先轉換為8-bit影像：`Image > Type > 8-bit`。

2.  **閾值分割 (Thresholding)：**
    *   在 `Brain Mask` 視窗上，執行 `Image > Adjust > Threshold...` (`Ctrl+Shift+T`)。
    *   **手動調整閾值：** 拖動下方滑桿，目標是讓腦組織（腦灰質與白質）被完整選取（顯示為紅色），同時盡可能排除周圍的腦脊髓液和頭骨。您會發現一個介於 30-140 左右的範圍可能是一個不錯的起點。
    *   點擊 `Apply`，將影像轉換為黑白的二值化影像。

3.  **形態學後處理 (Post-processing)：**
    *   此時的遮罩可能不完美，包含雜訊或空洞。我們用形態學操作來清理它。
    *   **填補空洞：** `Process > Binary > Fill Holes`。此步驟會填滿腦組織內部因對比度差異產生的小洞（如心室）。
    *   **去除雜訊：** `Process > Binary > Open`。此步驟可以移除一些與主體不相連的微小亮點雜訊。

4.  **選取最大物件：**
    *   經過處理後，影像中最大的連通區域應該就是腦部。我們使用粒子分析來分離它。
    *   執行 `Analyze > Analyze Particles...`。
    *   設定 `Size (pixel^2)` 為一個較大的值，例如 `5000-Infinity`，以確保只選取到腦部。
    *   在 `Show` 下拉選單中選擇 `Masks`。
    *   勾選 `Display results` 和 `Clear results`。
    *   點擊 `OK`。ImageJ 會產生一張新的遮罩影像，上面只剩下我們需要的腦組織遮罩。這就是最終的 `Brain Mask`。

### 方法二：使用機器學習進行分割 (更穩健、推薦)

當腦組織和頭骨的灰階強度非常相似時，單純的閾值分割會失敗。此時，我們應該使用 Fiji 內建的 **Trainable Weka Segmentation** 插件，它不僅依賴灰階值，還能學習紋理、邊緣等特徵，分割效果更佳。

1.  **開啟插件與設定：**
    *   開啟原始的 `t1-header.tif` 影像。
    *   執行 `Plugins > Segmentation > Trainable Weka Segmentation`。
    *   在 Weka 視窗中，點擊 `Settings`，確認 `Training features` 中的選項（預設即可）。
    *   點擊 `Create new class` 建立三個類別，並分別命名為 `Brain`, `Skull`, `Background`。

2.  **提供訓練樣本 (Training)：**
    *   **標記 Brain:** 在 Weka 視窗中選中 `Brain` 類別。使用 **手繪選取工具 (Freehand selection)**，在影像的腦組織區域畫幾個小圈，每畫一個就點擊 `Add to class 'Brain'` 按鈕。**技巧：** 請在不同的腦區（灰質、白質）和不同的 Z-slice 上都提供樣本。
    *   **標記 Skull:** 選中 `Skull` 類別，在頭骨的亮色區域畫圈並加入。
    *   **標記 Background:** 選中 `Background` 類別，在腦外的黑色區域（包括腦脊髓液和影像背景）畫圈並加入。

3.  **訓練與產生結果：**
    *   點擊 `Train classifier` 按鈕進行訓練。右側的預覽視窗會即時顯示分類結果。如果結果不理想，可以增加更多樣本並重新訓練。
    *   對預覽滿意後，點擊 `Create result`。這會產生一張新的**分類結果影像 (classified image)**。

4.  **從分類結果中提取腦部遮罩：**
    *   在產生的分類結果影像上，執行 `Image > Adjust > Threshold...`。
    *   在 Weka 中，第一個類別 (`Brain`) 的像素值通常是 1。將閾值滑桿的上下限都設為 **1**，這樣就只選取了腦部。
    *   點擊 `Apply`，即可得到一張乾淨的 `Brain Mask`。

---
**註：** 接下來分離頭骨的步驟，無論您使用方法一或方法二得到的 `Brain Mask`，操作流程都是一樣的。

## 3. 步驟二：分離頭骨 (Skull Segmentation)

分離頭骨的邏輯很簡單：**頭骨 = 整個頭部 - 腦組織**。

1.  **建立「整個頭部」的遮罩：**
    *   回到原始的 `t1-header.tif` 影像。
    *   再次執行 `Image > Adjust > Threshold...`。
    *   這次，將閾值下限設為 1（或一個非常低的值），上限設為最大值。目標是選取所有非黑色的像素。
    *   點擊 `Apply` 產生一個包含整個頭部（腦+頭骨）的遮罩。將其命名為 `Head Mask`。

2.  **影像計算 (Image Calculator)：**
    *   執行 `Process > Image Calculator...`。
    *   在對話框中設定：
        *   `Image1`: 選擇 `Head Mask`。
        *   `Operation`: 選擇 `Subtract` (減去)。
        *   `Image2`: 選擇我們在步驟一得到的 `Brain Mask`。
    *   點擊 `OK`。

3.  **得到頭骨遮罩：**
    *   計算結果就是一張新的影像，其中只剩下頭骨的遮罩。您可以將其命名為 `Skull Mask`。

## 4. 步驟三：3D 視覺化呈現

現在我們有了各自獨立的 `Brain Mask` 和 `Skull Mask`，可以使用 3D Viewer 將它們視覺化。

1.  **啟動 3D Viewer：**
    *   執行 `Plugins > 3D > 3D Viewer`。

2.  **加入腦組織表面：**
    *   在 3D Viewer 視窗中，點擊 `Add > Surface...`。
    *   在 `Image` 下拉選單中選擇 `Brain Mask`。
    *   `Name`: 可命名為 `Brain`。
    *   `Color`: 選擇一個您喜歡的顏色，例如灰色。
    *   `Threshold`: 設為 1。
    *   `Transparency`: 設定一個透明度，例如 `50%`，這樣才能看到內部。
    *   點擊 `OK`。

3.  **加入頭骨表面：**
    *   再次點擊 `Add > Surface...`。
    *   `Image`: 選擇 `Skull Mask`。
    *   `Name`: 可命名為 `Skull`。
    *   `Color`: 選擇白色或淡黃色。
    *   `Threshold`: 設為 1。
    *   `Transparency`: 設為一個較低的值，例如 `20%`。
    *   點擊 `OK`。

現在，您應該可以在 3D Viewer 中看到半透明的頭骨包覆著腦組織的立體模型。您可以用滑鼠自由地旋轉和縮放，從不同角度觀察這些結構。

## 5. 結論與後續分析

透過本教學，我們學習了一套標準的醫學影像分割流程：

1.  **閾值分割**：利用灰階值差異分離主要結構。
2.  **形態學處理**：清理並優化分割結果。
3.  **影像運算**：透過遮罩間的加減來分離複雜結構。
4.  **3D 視覺化**：將分割結果以立體模型呈現。

這些產生的遮罩（Masks）不僅可用於視覺化，更是定量分析的基礎。例如，您可以對 `Brain Mask` 影像堆疊執行 `Analyze > Histogram`，並將 `Count`（像素數）乘以每個體素（Voxel）的體積，就可以估算出總腦容量。

## 6. 定量分析：計算體積 (Volume Quantification)

得到腦組織和頭骨的遮罩後，最直接的應用之一就是計算它們的體積。這在臨床診斷和形態學研究中至關重要。

### 計算原理

體積計算的邏輯非常簡單：

**總體積 = 體素(Voxel)的總數量 × 單一體素的體積**

-   **體素 (Voxel):** 可以理解為 3D 空間中的一個像素點，它具有長、寬、高。
-   **體素總數量:** 在我們的二值化遮罩（如 `Brain Mask`）中，這就是所有白色像素的總和。
-   **單一體素的體積:** 這需要我們對影像進行空間校正，定義每個體素的真實物理尺寸。

根據此 MRI 數據集的官方資訊，其體素尺寸為 **1 mm × 1 mm × 1.33 mm**。

### 操作步驟

我們將以計算 **腦組織體積** 為例。計算頭骨體積的步驟完全相同，只需將操作對象換成 `Skull Mask` 即可。

#### 步驟 6.1: 設定空間校正 (Set Scale)

在進行任何測量之前，必須先讓 ImageJ 知道影像的真實尺度。

1.  選取 `Brain Mask` 或任何一張原始影像堆疊。
2.  執行 `Image > Properties...` (快捷鍵 `Ctrl+Shift+P`)。
3.  在彈出的對話框中，填入已知的體素尺寸：
    *   `Unit of length`: **mm**
    *   `Pixel width`: **1.0**
    *   `Pixel height`: **1.0**
    *   `Voxel depth`: **1.33** (這是 Z 軸的尺寸，即切片厚度)
4.  勾選 `Global`，這樣此設定會應用到所有開啟的影像。
5.  點擊 `OK`。

完成後，影像視窗的標題會顯示校正後的尺寸。

#### 步驟 6.2: 計算體素總數並獲得體積

有兩種推薦的方法可以得到體積。

**方法 A：使用直方圖 (Histogram)**

此方法讓您了解背後的計算過程。

1.  選取 `Brain Mask` 影像堆疊。
2.  執行 `Analyze > Histogram` (快捷鍵 `Ctrl+H`)。
3.  在彈出的 Histogram 視窗中，您會看到一個表格。由於這是二值化影像，只有兩個值：0 (黑色背景) 和 255 (白色前景)。
4.  找到 `Value` 為 **255** 的那一列，其對應的 `Count` 值就是白色體素的總數量。例如，我們得到 `Count = 1075345`。
5.  **手動計算體積：**
    *   單一體素體積 = 1.0 mm × 1.0 mm × 1.33 mm = 1.33 mm³
    *   總腦體積 = `1075345` (體素總數) × `1.33` mm³ ≈ `1,430,208` mm³
    *   我們也可以換算成更常用的單位： **1,430.2 cm³** (因為 1 cm³ = 1000 mm³)。

**方法 B：使用 3D 物件計數器 (3D Object Counter) (更直接)**

Fiji 內建的強大 3D 分析工具可以直接給出校正後的體積。

1.  選取 `Brain Mask` 影像堆疊。
2.  執行 `Analyze > 3D OC Options` 來設定參數，確保 `Volume` 已被勾選。
3.  執行 `Analyze > 3D Object Counter`。
4.  在設定視窗中，將 `Threshold` 設為一個介於 1-255 之間的值 (例如 128)，以確保只計算白色物件。
5.  點擊 `OK`。
6.  在彈出的 "3D Results" 表格中，`Volume` 欄位直接顯示了計算好的體積（單位為 mm³），並且 `Voxels` 欄位顯示了體素總數，與直方圖方法得到的結果一致。

使用相同的方法操作 `Skull Mask`，您就可以得到頭骨的體積了。