<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>automation-and-macro</title>
<link rel="stylesheet" href="styles.css">
<!-- KaTeX CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">
</head>
<body>

<div id="toc">
<h2><a href="index.html">回到首頁</a></h2>
<div class="toc-container">
<div class="toc">
<ul>
<li><a href="#imagej">ImageJ 自動化與巨集程式設計</a><ul>
<li><a href="#_1">巨集語言介紹</a><ul>
<li><a href="#_2">巨集錄製</a></li>
<li><a href="#_3">基本語法</a></li>
<li><a href="#_4">範例：基本操作</a></li>
<li><a href="#_5">函數與程序</a></li>
<li><a href="#_6">範例</a></li>
<li><a href="#slice">範例：使用者動作批次處理每一個slice</a></li>
<li><a href="#_7">使用者互動</a></li>
<li><a href="#_8">範例：使用者互動</a></li>
<li><a href="#_9">範例：文件批次處理</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

</div>
</div>
<div id="content">
<h1 id="imagej">ImageJ 自動化與巨集程式設計</h1>
<h2 id="_1">巨集語言介紹</h2>
<p>ImageJ使用一種簡單的內建腳本語言，稱為 <strong>ImageJ Macro Language</strong>。</p>
<ul>
<li>它具有基本的程式結構，包括變數、運算子、條件判斷和迴圈。</li>
<li>主要用於呼叫ImageJ的選單指令、操作影像窗口、讀取和寫入數據。</li>
</ul>
<h3 id="_2">巨集錄製</h3>
<p>ImageJ提供了一個方便的巨集錄製器，可以將手動操作轉換為巨集程式碼。</p>
<ul>
<li>錄製器會記錄您在選單中執行的大多數操作以及一些對話框互動。</li>
<li>這是學習巨集語法和了解特定操作對應的指令的絕佳方式。</li>
</ul>
<p>在ImageJ中錄製巨集：</p>
<ul>
<li>開啟 <code>Plugins &gt; Macros &gt; Record...</code>。</li>
<li>錄製窗口會彈出，顯示正在記錄的指令。</li>
<li>執行您想要自動化的手動步驟（例如：開啟影像、調整亮度/對比度、套用濾波器、執行分析）。</li>
<li>執行完畢後，點擊錄製窗口中的 <code>Create</code> 按鈕，將記錄的程式碼輸出到一個新的巨集編輯器窗口。</li>
<li>點擊 <code>Close</code> 停止錄製。</li>
<li>錄製的程式碼可以在巨集編輯器中進行修改和調整。可以編輯參數、加入流程控制或使用者互動。</li>
</ul>
<h3 id="_3">基本語法</h3>
<p>ImageJ Macro Language 的語法類似於C語言或其他腳本語言，但更簡化。
- 變數無需顯式宣告類型，直接賦值即可。
- 常見的運算子（+、-、*、/、=、&gt;、&lt;、==、!= 等）皆可使用。
- 條件判斷使用 <code>if</code> 和 <code>if...else</code> 結構。
- 迴圈結構包括 <code>for</code> 和 <code>while</code>。</p>
<h3 id="_4">範例：基本操作</h3>
<pre><code class="language-ijm">// ==== 1. 數值類型與變數 ====
var number = 123;
var decimal = 3.14;
var text = &quot;Hello ImageJ&quot;;
var array = newArray(1, 2, 3, 4, 5);

print(&quot;Number: &quot; + number);
print(&quot;Decimal: &quot; + decimal);
print(&quot;Text: &quot; + text);

// 列印陣列
print(&quot;Array elements:&quot;);
for (i = 0; i &lt; array.length; i++) {
    print(array[i]);
}


// ==== 2. 算術運算 ====
var a = 10;
var b = 3;

sum = a + b;
difference = a - b;
product = a * b;
quotient = a / b;

x = 5;
y = 7;
x += 1; // x = 6
y *= 2; // y = 14

print(&quot;Sum: &quot; + sum);
print(&quot;Difference: &quot; + difference);
print(&quot;Product: &quot; + product);
print(&quot;Quotient: &quot; + quotient);
print(&quot;x after +=1: &quot; + x);
print(&quot;y after *=2: &quot; + y);

// ==== 3. 邏輯運算 ====
var value = 75;
var threshold = 50;

if (value &gt; threshold) {
    print(&quot;Above threshold&quot;);
}

var x_val = 10;
var y_val = 20;

if (x_val &gt; 0 &amp;&amp; y_val &lt; 100) {
    print(&quot;Within range&quot;);
}

if (x_val &lt; 0 || y_val &gt; 100) {
    print(&quot;Out of range&quot;);
} else {
    print(&quot;Safe range&quot;);
}

</code></pre>
<h3 id="_5">函數與程序</h3>
<ul>
<li>ImageJ巨集語言提供了大量的內建函數和程序（指令）。</li>
<li>內建函數： 用於執行特定的操作，例如數學計算、字串處理、檔案操作、獲取影像資訊等。它們通常有返回值。</li>
<li>程序（指令）： 大多數對應ImageJ的選單命令或對話框操作。它們執行一個動作，通常沒有返回值。可以使用<strong>run()</strong> 命令或直接使用指令名稱調用。</li>
<li>自定義函數： 您可以編寫自己的函數來組織程式碼和重用邏輯。</li>
</ul>
<h3 id="_6">範例</h3>
<pre><code class="language-ijm">
// 建立測試影像
newImage(&quot;Test&quot;, &quot;8-bit black&quot;, 256, 256, 1);
print(&quot;Image created: &quot; + getTitle());

// 獲取影像尺寸
width = getWidth();
height = getHeight();
print(&quot;Width: &quot; + width + &quot;, Height: &quot; + height);

// 設定與讀取像素值
x = 100;
y = 100;
setPixel(x, y, 255); // 設定像素為白色
value = getPixel(x, y); // 讀取像素值
print(&quot;Pixel value at (&quot; + x + &quot;,&quot; + y + &quot;): &quot; + value);

// ==== 2. 用戶交互 ====

// 對話框輸入數字
Dialog.create(&quot;Input Example&quot;);
Dialog.addNumber(&quot;Value:&quot;, 0);
Dialog.show();
userValue = Dialog.getNumber();
print(&quot;User entered value: &quot; + userValue);

// 文件選擇
filePath = File.openDialog(&quot;選擇檔案&quot;);
print(&quot;你選擇的檔案: &quot; + filePath);
</code></pre>
<h3 id="slice">範例：使用者動作批次處理每一個slice</h3>
<pre><code class="language-ijm">
// ================================
// ImageJ Macro 範例：生成 Stack 並分析每個 slice
// ================================

macro &quot;Generate Stack and Analyze&quot; {

    // ==== 1. 生成 Stack ====
    width = 256;
    height = 256;
    n = 5; // Stack 幀數

    newImage(&quot;StackExample&quot;, &quot;8-bit black&quot;, width, height, n);

    // 填充每一幀測試數據 (隨機亮點)
    for (i = 1; i &lt;= n; i++) {
        setSlice(i);
        for (j = 0; j &lt; 100; j++) { // 100 個隨機亮點
            x = floor(random() * width);
            y = floor(random() * height);
            setPixel(x, y, 255);
        }
    }

    print(&quot;Stack created with &quot; + nSlices + &quot; slices.&quot;);

    // ==== 2. 設置測量參數 ====
    run(&quot;Set Measurements...&quot;, &quot;integrated display redirect=None decimal=3&quot;);

    // ==== 3. 對每一 slice 分析 ====
    waitForUser(&quot;圈選區域&quot;);        
    setTool(0);

    for (i = 1; i &lt;= n; i++) {
        setSlice(i);                

        run(&quot;Measure&quot;);
    }

    print(&quot;Stack analysis completed.&quot;);
}

</code></pre>
<h3 id="_7">使用者互動</h3>
<p>巨集可以與使用者進行互動，例如顯示訊息、請求使用者輸入參數。
這使得巨集更加靈活，可以適應不同的影像和需求。</p>
<ul>
<li>訊息提示： 使用 <strong>print()</strong> 函數將訊息輸出到Log窗口；使用 <strong>showMessage()</strong> 或 <strong>showMessageWithCancel()</strong> 彈出訊息對話框。   </li>
<li>參數輸入： 使用 <strong>Dialog.create()</strong> 創建自定義對話框，並使用 <strong>Dialog.addNumber()</strong>, <strong>Dialog.addString()</strong>, <strong>Dialog.addCheckbox()</strong>, <strong>Dialog.addCheckbox()</strong> 等方法添加輸入控件。最後使用 <strong>Dialog.show()</strong> 顯示對話框並獲取使用者輸入的值。</li>
</ul>
<h3 id="_8">範例：使用者互動</h3>
<pre><code class="language-ijm">// 範例：彈出對話框讓使用者輸入粒子分析的最小尺寸
Dialog.create(&quot;粒子分析參數&quot;);
Dialog.addNumber(&quot;最小粒子尺寸 (pixels):&quot;, 100);
Dialog.show();
minSize = Dialog.getNumber();

if (minSize &gt; 0) {
    run(&quot;Analyze Particles...&quot;, &quot;size=&quot; + minSize + &quot;-Infinity display&quot;);
} else {
    print(&quot;最小尺寸無效，跳過分析。&quot;);
}
</code></pre>
<h3 id="_9">範例：文件批次處理</h3>
<pre><code class="language-ijm">// ===== 主流程 Macro =====
macro &quot;產生粒子範例並測量&quot; {

    // ==== 1. 生成範例影像 ====

    imageN = 5; // 生成 5 張範例影像
    width = 512;
    height = 512;

    imgDir = getDirectory(&quot;選擇存檔資料夾&quot;);        
    generateSampleImages(imgDir, imageN, width, height);

    // ==== 2. 批次處理生成的範例影像 ====

    files = getFileList(imgDir);

    for (i = 0; i &lt; files.length; i++) {
        if (endsWith(files[i], &quot;.tif&quot;)) {
            processFile(imgDir + files[i]);
        }
    }
    // 將 summary 表格輸出到 CSV
    outputDir = getDirectory(&quot;選擇選擇要輸出的資料夾&quot;);        
    resultsFile = outputDir + &quot;測量結果.csv&quot;;    
    saveAs(&quot;Results&quot;, resultsFile);
}

// ===== 生成範例影像 =====
function generateSampleImages(imgDir, imageN, width, height) {
    for (i = 1; i &lt;= imageN; i++) {
        newImage(&quot;Sample_&quot; + i, &quot;8-bit black&quot;, width, height, 1);

        // 生成隨機亮點
        for (j = 0; j &lt; 50; j++) { // 50 個亮點
            x = floor(random() * width);
            y = floor(random() * height);
            setPixel(x, y, 255);
        }

        saveAs(&quot;Tiff&quot;, imgDir + &quot;Sample_&quot; + i + &quot;.tif&quot;);
        close();
    }
}

// ===== 測量 =====
function processFile(inputPath) {
    open(inputPath);


    // 測量粒子
    run(&quot;Set Measurements...&quot;, &quot;area mean min max centroid redirect=None decimal=2&quot;);
    run(&quot;Analyze Particles...&quot;, &quot;size=1-Infinity show=Nothing summarize&quot;);
    close();

}
</code></pre>
</div>

<!-- Mermaid JS -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({}); // Keep double braces for literal JS object
  mermaid.run({ nodes: document.querySelectorAll('.language-mermaid') }); // Keep double braces
</script>

<!-- KaTeX JS -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"></script>
<!-- *** CORRECTED SCRIPT WITH ${...} ESCAPING *** -->
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                renderMathInElement(document.body, {
                    delimiters: [
                        { left: '$$',  right: '$$',  display: true },
                        { left: '\\[', right: '\\]', display: true },
                        { left: '\\(', right: '\\)', display: false }
                    ],
                    ignoredTags: ['script','noscript','style','textarea','pre','code'],
                    throwOnError: false
                });
            });
        </script>

</body>
</html>
