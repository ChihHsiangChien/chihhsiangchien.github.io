# 從一片葉子學分析：空間校正、色彩空間與分割技巧

本章節將以 ImageJ 內建的 `Leaf` 範例影像為核心，進行完整的影像分析流程。過程包括：

1.  如何利用影像中的比例尺進行**空間校正**。
2.  理解 **RGB** 與 **HSB (HSV)** 色彩空間的差異，以及為何後者更利於顏色分割。
3.  使用 **Color Threshold** 和 **標準 Threshold** 兩種方法來分割出目標物。
4.  進行多種科學測量，包括**面積**、**周長**，以及**碎形分析**。

## 1. 開啟範例與空間校正

沒有正確的校正，所有的測量都只是像素遊戲。讓我們先賦予影像真實的物理單位。

1.  開啟範例影像 `File > Open Samples > Leaf (36K)`。
2.  影像上方有一支尺。這就是我們校正的依據。
3.  從工具列選擇**直線工具 (Line Tool)**。
4.  沿著 `2 cm` 的黑色線段，從一端精確地畫到另一端。
5.  執行 `Analyze > Set Scale...`。
6.  在彈出的對話框中：
    *   `Distance in pixels`: ImageJ 會自動填入您剛畫的線段長度。
    *   `Known distance`: 輸入 **2**。
    *   `Unit of length`: 輸入 **cm**。
    *   `Global`: **建議不要勾選**，這樣此校正只會應用於這張葉子影像。
    *   點擊 `OK`。

現在，您的影像已經被校正。之後的所有測量單位都將是 `cm`。

## 2. 認識色彩空間：為何需要 HSB？

我們要如何從影像中分離出「綠色」的葉子？在電腦中，顏色通常用兩種模型來描述：

-   **RGB (Red, Green, Blue):**
    -   這是最常見的**硬體導向**模型，對應螢幕顯示的三原色光。
    -   **缺點：** 對人類不直觀。一片葉子的「綠色」可能包含多種不同的R、G、B組合（亮綠、暗綠、黃綠），很難用簡單的RGB範圍來定義。

-   **HSB (Hue, Saturation, Brightness)，也常稱為 HSV (Value):**
    -   這是**人類視覺導向**的模型，更符合我們描述顏色的方式。
    -   **色相 (Hue):** 純粹的顏色，如紅、黃、綠、藍。可以想成一個360度的色環。
    -   **飽和度 (Saturation):** 顏色的純度或鮮豔度。從灰色到最鮮豔的顏色。
    -   **亮度 (Brightness/Value):** 顏色的明暗程度。


### 實作：分離所有通道並用直方圖評估

以下將 RGB 和 HSB 通道全部拆分出來，並用直方圖來「定量」地觀察它們的差異。

1.  確保 `Leaf` 影像是當前視窗。
2.  **分離 HSB 通道：** 執行 `Image > Type > HSB Stack`。您會得到一個包含 `Hue`, `Saturation`, `Brightness` 三個灰階影像的堆疊。
3.  **拆分 HSB stack為不同影像**，執行 `Image › Stacks › Stack to Images...`。會將剛剛的堆疊拆成三張影像。

4.  **分離 RGB 通道：** 再載入 `Leaf` 影像視窗，執行 `Image > Color > Split Channels`。您會得到 `(red)`, `(green)`, `(blue)` 三個獨立的灰階影像。
5.  **觀察直方圖：** 依序點選這六個灰階影像中的任意一個，執行 `Analyze > Histogram` (或按 `Ctrl+H`) 來查看其像素分佈。

#### 觀察與分析

1. 觀察6張直方圖的表現，有沒有哪一張直方圖呈現明顯的峰，而且彼此不重疊，並觀察這些峰實際上代表影像的哪個部份？

#### 分割的原理與決策

**影像分割 (Segmentation)** 的核心原理是**根據像素的某一項特徵將其分類**。最簡單的方法是**閾值分割 (Thresholding)**，即「設定一個值，高於此值的為目標，低於此值的為背景」。

一個好的分割策略，就是要選擇一個能最大化「目標」與「背景」差異的特徵。**直方圖就是我們用來評估這個差異的工具。**

**決策依據：** 一個適合用來分割的通道，其直方圖應該呈現**雙峰分佈 (Bimodal)**，且兩個峰之間有**清晰、深邃的山谷**。這個山谷就是設定閾值的最佳位置。

## 3. 分割葉片區域 (Segmentation)

我們將介紹兩種方法來分離葉子。

### 方法一：Color Threshold (在原始RGB影像上)

此方法直接在彩色影像上操作，非常直觀。

1.  關閉 `HSB Stack`，重新開啟原始的 `Leaf` 影像。
2.  執行 `Image > Adjust > Color Threshold...`。
3.  在 `Color Threshold` 視窗中：
    *   將下拉選單從預設的 `RGB` 改為 `HSB`。
    *   **調整滑桿：** 將代表綠色的區間選取起來。您會看到影像預覽中，只有葉子被標示為紅色。
    *   可以微調 Saturation 和 Brightness 滑桿來排除背景中的雜點。
    *   確認選取範圍無誤後，點擊視窗下方的 `Select` 按鈕。

此時，葉子的輪廓已經被建立成一個**選區 (ROI)**。您可以直接進行測量。

### 方法二：Standard Threshold (在 8-bit影像上使用)

此方法是影像分割的經典流程：先將影像轉換為單一的灰階通道，然後再使用 `Image > Adjust > Threshold...` 進行分割。關鍵在於選擇一個最能凸顯目標的灰階通道。從我們先前的直方圖分析可知，**Saturation 通道**是最佳選擇。但為了完整性，我們也介紹另一種常見的灰階轉換方式。
#### 做法 A: 使用 Saturation 通道
1.  使用我們在步驟2中產生的 **HSB Stack** 影像。
2.  點選 **Saturation** 通道的視窗 (或是從 HSB Stack 中選擇 Saturation 切片)。
3.  執行 `Image > Adjust > Threshold...` (或按 `Ctrl+Shift+T`)。
4.  拖動滑桿，將代表葉片的灰色區域選取起來。
5.  點擊 `Apply`。影像會被轉換成一張黑白的**二值化遮罩 (Binary Mask)**，白色代表目標區域(前景)，黑色代表背景。

#### 做法 B: 直接轉換為 8-bit 灰階影像
1.  重新載入一張原始的 `Leaf` 影像。
2.  執行 `Image › Type › 8-bit`。
    - **原理說明:** 這一步會將 RGB 彩色影像轉換為 8-bit 灰階影像。ImageJ 提供兩種轉換公式，可在 `Edit > Options > Conversions...` 中設定：
        - **平均法 (預設不勾選 "Weighted RGB to Grayscale Conversion"):**
          `灰階值 = (紅 + 綠 + 藍) / 3`
        - **加權法 (勾選 "Weighted RGB to Grayscale Conversion"):** 這種方法更符合人眼對綠色的敏感度。
          `灰階值 = 0.299 * 紅 + 0.587 * 綠 + 0.114 * 藍`
3.  對這張新產生的 8-bit 灰階影像執行 `Image > Adjust > Threshold...`。
4.  **比較與思考：** 試著用這種方式分割葉子，並比較其直方圖與 `Hue` 通道的直方圖。您會發現，直接轉換的灰階影像，其葉子與背景的灰階值比較多重疊，很難找到一個完美的閾值，因此需要選擇合適的通道。

無論使用何種方法，最終產生的二值化遮罩是後續進行粒子分析和測量的基礎。

## 裁剪影像以聚焦分析區域 (Cropping)

在進行測量之前，一個很好的習慣是將影像裁剪(Crop)到只剩下我們感興趣的物體。這樣做可以去除像尺標、背景雜訊等不必要的干擾，讓後續的分析更單純。

1.  **選取葉子區域:**
    *   在經過分割、產生**二值化遮罩**的影像上，從工具列選擇**矩形選取工具 (Rectangle Selection Tool)**。
    *   畫一個剛剛好能框住整個白色葉片區域的矩形。或者你也可在進行分割之前就先裁剪出目標區域，再進行分隔。

2.  **執行裁剪:**
    *   執行 `Image > Crop`。

**觀察結果：**

影像會被裁切成您所選取矩形的大小，只留下葉子主體。接下來的所有測量都將在這個更乾淨、更聚焦的影像上進行，可以避免不小心測量到影像邊緣的雜訊。

## 4. 進行測量

現在我們有了葉子的選區或遮罩，可以開始測量了。若**二值化遮罩**影像有多個不相連的白色區域，可先使用工具列上的 **魔術棒工具 (Wand Tool)** (快捷鍵 `W`)，在要測量的目標白色區域內點擊一下，系統會自動選取相連的白色區域。

### 測量策略：使用選區 vs. 直接分析二值化影像

在 ImageJ 中，有兩種主要的測量路徑，了解它們的差異至關重要：

1.  **在原始影像上使用「選區」(ROI) 進行測量 (`Analyze > Measure`)**
    *   **這是什麼？** 「選區」是一個浮動的輪廓（ROI），它定義了測量的邊界，但測量的是**底下原始影像**的像素值。
    *   **流程：** 將二值化遮罩轉換為選區 (例如，使用魔術棒工具點擊)，然後切換回**原始影像**（如 `Leaf.jpg` 或某個灰階通道），再按下 `Ctrl+M`。
    *   **何時使用？** 當您需要測量**原始強度**相關的參數時。例如，您想知道葉片區域在原始影像中的「平均綠色強度」或「積分密度」。您用分割好的輪廓來界定範圍，但數據來源是原始影像。

2.  **直接分析「二值化影像」(Mask) (`Analyze > Analyze Particles...`)**
    *   **這是什麼？** 直接在黑白遮罩影像上進行分析。此時，白色像素本身就是被測量的對象。
    *   **流程：** 保持**二值化影像**為當前視窗，執行 `Analyze > Analyze Particles...`。
    *   **何時使用？** 當您主要關心物體的**形狀或數量**時。例如，測量葉片**面積**、**周長**、**圓形度**或計算影像中有多少個物體。此時，原始影像的灰階值已不重要。

> **總結：**
>
>    * 想測量**「形狀」** (`Area`, `Perimeter`) 或**「計數」** → 直接分析**二值化影像**。
>    * 想測量**「強度」** (`Mean`, `IntDen`) → 在**原始影像**上套用**選區**。

### 認識測量參數 (Set Measurements)

在執行 `Analyze > Measure` 或 `Analyze Particles...` 之前，我們可以透過 `Analyze > Set Measurements...` 指令來決定結果表格中要顯示哪些測量項目。了解這些參數的意義，能幫助您選擇最適合研究目的的量化指標。

以下是常用參數的說明：

#### 基本與強度測量

| 參數 (選項) | 結果欄位 | 說明 |
|:---|:---|:---|
| **Area** | `Area` | 選區的面積。如果影像經過空間校正，單位會是物理單位（如 cm²），否則為像素平方 (pixels²)。 |
| **Mean Gray Value** | `Mean` | 選區內所有像素的平均灰階值。若經過強度校正，則單位為校正後的物理單位。對於RGB影像，會先轉換為灰階再計算。 |
| **Standard Deviation** | `StdDev` | 選區內像素灰階值的標準差，反映了亮度的離散程度。 |
| **Min & Max Gray Level** | `Min`, `Max` | 選區內的最小與最大灰階值。 |
| **Modal Gray Value** | `Mode` | 選區內出現頻率最高的灰階值（眾數），對應直方圖的最高峰。 |
| **Median** | `Median` | 選區內像素灰階值的中位數。相較於平均值，較不受極端值（雜訊點）影響。 |
| **Integrated Density** | `IntDen`, `RawIntDen` | **積分密度**。`IntDen` = `Area` × `Mean`；`RawIntDen` = 選區內所有像素的灰階值總和。在螢光定量等分析中非常重要，能反映選區內訊號的總量。 |
| **Skewness** | `Skew` | **偏度**。衡量灰階分佈的不對稱性。正偏態表示分佈偏向左側（低亮度），負偏態表示偏向右側（高亮度）。 |
| **Kurtosis** | `Kurt` | **峰度**。衡量灰階分佈的峰態陡峭程度。高聳的峰態有較高的峰度值。 |

#### 形狀與位置測量

| 參數 (選項) | 結果欄位 | 說明 |
|:---|:---|:---|
| **Perimeter** | `Perimeter` | 選區的邊界長度（周長）。 |
| **Centroid** | `X`, `Y` | **形心（幾何中心）**。選區所有像素點X、Y座標的算術平均值，代表物體的幾何中心位置。 |
| **Center of Mass** | `XM`, `YM` | **質心**。以像素亮度為權重的座標平均值。質心會偏向選區中較亮的區域。 |
| **Bounding Rectangle**| `BX`, `BY`, `Width`, `Height` | **邊界矩形**。能完全包圍選區的最小矩形。回傳其左上角座標(BX, BY)及寬高。 |
| **Feret's Diameter** | `Feret`, `FeretAngle`, `MinFeret` | **費雷特直徑（最大口徑）**。選區邊界上任意兩點間的最長距離。`MinFeret` 則是最小口徑。常用來描述不規則物體的尺寸。 |
| **Fit Ellipse** | `Major`, `Minor`, `Angle` | **擬合橢圓**。計算出最能貼合選區的橢圓，並回傳其長軸(`Major`)、短軸(`Minor`)及長軸與X軸的夾角(`Angle`)。 |
| **Shape Descriptors** | `Circ.`, `AR`, `Round`, `Solidity` | **形狀描述子**，一組用來量化形狀的指標：<br> - **`Circ.` (圓形度):** `4π*面積/周長²`。值為1.0表示完美的圓形，越接近0.0表示越狹長。<br> - **`AR` (長寬比):** `長軸/短軸`，需同時啟用 "Fit Ellipse"。<br> - **`Round` (圓度):** `4*面積/(π*長軸²)`，是長寬比的倒數。<br> - **`Solidity` (實心度):** `面積/凸包面積`。值接近1表示物體較實心、無凹陷。 |

#### 其他設定

| 參數 (選項) | 說明 |
|:---|:---|
| **Area Fraction** | 顯示被閾值（Threshold）標紅的像素所佔的面積百分比。 |
| **Limit to Threshold** | 勾選後，所有測量（如Mean, Min, Max）都只會計算被閾值標紅的像素，忽略選區內未被標紅的像素。這對於在不完美的分割區域中精確測量訊號非常有用。 |
| **Stack Position** | 在處理影像堆疊（Stack）時，記錄測量發生在哪個通道(`Ch`)、切片(`Slice`)或幀(`Frame`)。 |
| **Display Label** | 在結果表格的第一欄顯示影像名稱和切片編號，方便辨識數據來源。 |
| **Redirect To** | **重定向**。允許您在影像A上圈選ROI，但實際測量影像B上對應位置的像素值。對於多通道分析（如在DAPI通道上圈核，測量GFP通道的強度）極為重要。 |
| **Decimal Places** | 設定結果表格中小數點後顯示的位數。 |


### 實作：測量形狀參數 (面積與周長)

測量面積與周長這類形狀參數時，我們關心的是物體的輪廓，而不是其內部像素的灰階值。因此，無論是直接分析**二值化影像**，還是在任意影像上使用由該輪廓建立的**選區(ROI)**，得到的面積和周長結果都會是**一樣的**。

以下我們介紹兩種等效的方法。

#### 方法 A: 使用 `Analyze Particles...` (推薦用於多物件分析)

此指令會自動掃描整張**二值化影像**，找出所有白色物體並逐一測量。

1.  使用 **二值化遮罩** 影像。
2.  執行 `Analyze > Set Measurements...`，確保 `Area` 和 `Perimeter` 都已勾選。
3.  執行 `Analyze > Analyze Particles...`。
    *   `Size (cm^2)`: 可以設定一個最小值（如 `0.1`）來過濾掉可能的微小雜訊。
    *   `Show`: 選擇 `Outlines`，這樣可以在新視窗中看到被測量的物體輪廓。
    *   勾選 `Display results` 和 `Summarize`。
4.  點擊 `OK`。
5.  **觀察結果：** 在 "Results" 表格中，您會看到每個被偵測到的粒子（葉子）的 `Area` 和 `Perimeter`。

#### 方法 B: 使用 `Analyze > Measure` (推薦用於單一物件測量)

此指令只會測量當前**作用中的選區 (ROI)**。

1.  在 **二值化遮罩** 影像上，使用 **魔術棒工具 (Wand Tool)** 點擊白色葉片區域，建立選區。
2.  執行 `Analyze > Set Measurements...`，確保 `Area` 和 `Perimeter` 都已勾選。
3.  執行 `Analyze > Measure` (或按 `Ctrl+M`)。
4.  **觀察結果：** 在 "Results" 表格中，您會看到一行數據，其中的 `Area` 和 `Perimeter` 與方法A的結果相同。

> **重點：** 由於 `Area` 和 `Perimeter` 只跟選區的形狀有關，所以當您使用方法B時，即使將選區套用到原始的彩色 `Leaf` 影像上再按 `Ctrl+M`，得到的 `Area` 和 `Perimeter` 數值依然不變。改變的只會是 `Mean`、`Min`、`Max` 等與像素強度相關的測量值。這也再次印證了我們在「測量策略」章節中的結論。

### 實作：進階測量 (碎形維度)

碎形維度 (Fractal Dimension) 是一個用來描述複雜、不規則邊界的指標。一個平滑的圓周長，其碎形維度接近1；而一個極度皺褶、複雜的海岸線，其維度會更高（例如1.2~1.3）。我們可以藉此量化葉緣的複雜程度。

> **碎形維度測量的意義與用途**
>
> 傳統的歐幾里得幾何（如周長、面積）擅長描述規則形狀，但對於自然界中常見的複雜、不規則的結構（如海岸線、雲朵、血管網路）就顯得力不從心。碎形維度（D）提供了一個超越傳統整數維度（線=1D, 面=2D, 體=3D）的量化指標，用來描述一個物體**「填充空間」的複雜程度**。
>
> -   **數值解讀：** 一個二維輪廓的碎形維度 D 值介於1和2之間。D值越接近1，表示邊界越平滑、簡單（像一條直線）。D值越接近2，表示邊界越曲折、複雜，幾乎快要能填滿一個平面。
>
> -   **應用舉例：**
>     -   **神經科學：** 量化神經元樹突分支的複雜度。一個D值較高的神經元，可能代表其連結能力更強或更成熟。
>     -   **腫瘤學：** 分析腫瘤邊緣的規律性。惡性腫瘤的邊緣通常更不規則，其碎形維度可能比良性腫瘤更高。
>     -   **植物學：** 比較不同生長條件下，植物根系或葉緣的複雜程度。
>     -   **材料科學：** 描述材料斷裂面的粗糙度。

1.  使用**二值化遮罩**影像。
2.  執行 `Analyze > Tools > Fractal Box Count...`。
3.  ImageJ 會產生一個圖表和一個 Log 視窗。在 Log 視窗中，您會看到 `D=1.234` 這樣的數值，這個 **D 值**就是葉緣的碎形維度。這個值越高，代表葉緣越不規則、越複雜。[Box Counting細節說明](https://imagej.net/ij/plugins/fraclac/FLHelp/BoxCounting.htm)

