# 形態學分割 (Morphological Segmentation) 

## 簡介

Morphological Segmentation結合了形態學操作（如擴展最小值、形態學梯度）與分水嶺演算法，能夠對各種類型（8、16、32 位元）的 2D 和 3D 灰度影像進行高效分割。


---

## 操作流程

1.  **開啟影像**：在 Fiji 中開啟任何灰度影像（單一 2D 影像或 3D 堆疊）。
2.  **啟動插件**：執行 `Plugins > MorphoLibJ > Segmentation > Morphological Segmentation`。
3.  **設定參數**：在插件視窗中，依序設定「輸入影像」、「分水嶺分割」的參數。
4.  **執行分割**：點擊 `Run` 按鈕。
5.  **檢視與匯出**：在「結果面板」中選擇不同的顯示方式，並可將結果匯出為新影像。
6.  **後處理**：如有需要，可使用「後處理面板」的功能對分割結果進行微調。

> **提示：** 在主畫布中，您可以隨時平移、縮放或滾動切片，就像操作一般 ImageJ 視窗一樣。

---

## 參數詳解

### 1. 輸入影像面板 (Input Image Panel)

此面板用於定義輸入影像的性質。這是關鍵的第一步，因為分水嶺演算法預期物件的邊界具有較高的強度值（即影像的梯度）。

-   **邊界影像 (Border Image):** 如果您的輸入影像**已經是**經過邊緣檢測或梯度計算的結果（例如，物件邊界是亮線），請選擇此項。

-   **物件影像 (Object Image):** 如果您的輸入影像是原始影像，其中物件本身比背景亮或暗，請選擇此項。選擇後會啟用以下選項：
    -   **梯度類型 (Gradient Type):** 選擇計算梯度的演算法。
    -   **半徑 (Radius):** 設定計算梯度時的半徑（以像素為單位）。
    -   **顯示梯度影像 (Display gradient image):** 勾選後，主畫布將顯示計算出的梯度影像，方便觀察。

> **影像預處理：** 此外掛程式雖內建梯度計算，但根據影像特性，您可能仍需在執行此前進行其他預處理，如降噪（`Process > Filters > Gaussian Blur`）或背景校正（`Process > Subtract Background`）。

### 2. 分水嶺分割面板 (Watershed Segmentation Panel)

此面板用於設定分割演算法的核心參數。

-   **容差 (Tolerance):**
    -   **作用：** 控制搜尋區域最小值（Regional Minima）的強度動態範圍。這是影響分割結果最重要的參數。
    -   **效果：**
        -   **增加容差值**：會合併更多相似區域，減少最終分割出的物件數量（防止過度分割）。
        -   **減少容差值**：對強度變化更敏感，會產生更多的分割物件。
    -   **注意：** 此值與影像的位元深度密切相關。
        -   **8-bit 影像 (0-255):** 建議從 `10` 開始嘗試。
        -   **16-bit 影像 (0-65535):** 應大幅增加，例如 `2000`。
    > **實例應用：** 根據您的輸入範例「設定Tolerance35」，您應該在「容差 (Tolerance)」輸入框中填入數值 `35`。

#### 高級選項 (Advanced options)
點擊後可設定更多參數：

-   **計算壩線 (Calculate dams):**
    -   **勾選 (預設):** 在分割出的不同物件之間產生單像素寬的邊界線（即「壩」）。
    -   **不勾選:** 產生填滿顏色的區域，物件之間直接相鄰，沒有邊界線。

-   **連通性 (Connectivity):**
    -   **作用：** 定義像素的鄰域關係。
    -   **選項：** 2D 可選 4 或 8；3D 可選 6 或 26。
    -   **建議：** 選擇非對角線的連通性（2D用`4`，3D用`6`）通常能產生更圓滑、自然的物件輪廓。

---

### 3. 結果面板 (Result Panel)

此面板在執行分割後啟用，用於視覺化與匯出結果。

-   **顯示 (Display):** 提供四種視覺化模式：
    -   **疊加盆地 (Overlaid basins):** 在原始影像上以不同顏色疊加分割出的物件。
    -   **疊加壩線 (Overlaid dams):** 在原始影像上以紅色疊加分水嶺邊界線。
    -   **集水盆地 (Catchment basins):** 產生一張新的彩色標籤影像，每個物件有獨立的顏色。
    -   **分水嶺線 (Watershed lines):** 產生一張新的二值影像，顯示黑色的邊界線與白色的物件。

-   **顯示結果疊加層 (Show result overlay):** 用於快速開關疊加層的顯示。
-   **建立影像按鈕 (Create image button):** 將當前畫布中顯示的結果（包含疊加層）儲存為一張新的影像。

---

### 4. 後處理面板 (Post-processing Panel)

此面板在執行分割後啟用，提供手動修正工具。

-   **合併標籤 (Merge labels):**
    -   **用途：** 手動合併被過度分割的區域。
    -   **操作：** 使用 **手繪選取工具** 或 **點工具** 選取多個想合併的物件，然後點擊此按鈕。第一個被選中的物件顏色將應用於所有被選物件。
> **多切片操作提示：** 在 3D 堆疊中，可使用「點工具」並按住 `SHIFT` 鍵，在不同切片上點選要合併的物件。

-   **隨機顏色 (Shuffle colors):**
    -   **用途：** 當相鄰的兩個物件被分配到相似顏色，難以區分時，點擊此按鈕可隨機重新分配所有顏色，以利觀察。

# 實作
使用範例影像`Blobs`進行分割，Tolerance設定35。