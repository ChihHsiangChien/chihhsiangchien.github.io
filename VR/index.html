<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360Â° VR æŸ¥çœ‹å™¨</title>
    <link rel="stylesheet" href="style-modular.css">
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    
    <!-- åœºæ™¯é€‰æ‹©å™¨ -->
    <div id="scene-selector" class="scene-selector"></div>
    
    <!-- åœºæ™¯åç§° -->
    <div id="scene-name" class="scene-name"></div>
    
    <!-- Hotspotså®¹å™¨ -->
    <div id="hotspots-container"></div>
    
    <!-- ç¼©æ”¾æ§åˆ¶ -->
    <div class="controls">
        <button id="zoom-in" class="control-btn">+</button>
        <button id="zoom-out" class="control-btn">âˆ’</button>
    </div>
    
    <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
    <div id="debug-info" class="debug-info">
        <div>Î±: <span id="debug-alpha">0</span></div>
        <div>Î²: <span id="debug-beta">0</span></div>
        <div>FOV: <span id="debug-fov">0</span></div>
        <div>X: <span id="debug-x">0</span></div>
        <div>Y: <span id="debug-y">0</span></div>
        <div>Z: <span id="debug-z">0</span></div>
    </div>

    <!-- Babylon.jsåº“ -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    
    <!-- èµ„æºç®¡ç†åŠ©æ‰‹ -->
    <script src="asset-helper.js"></script>
    
    <!-- VRæŸ¥çœ‹å™¨æ ¸å¿ƒæ¨¡å— -->
    <script src="vr-viewer.js"></script>
    
    <!-- ä¸»é¢˜é€‰æ‹©å™¨é¢æ¿ -->
    <div id="theme-selector-panel" class="theme-selector-panel">
        <h2>é¸æ“‡ä¸»é¡Œ</h2>
        <div id="theme-options" class="theme-options"></div>
    </div>
    
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button id="theme-switcher-btn" class="theme-switcher-btn" title="åˆ‡æ¢ä¸»é¢˜">ğŸ¨</button>
    
    <!-- åŠ¨æ€åŠ è½½ä¸»é¢˜å’Œåˆå§‹åŒ– -->
    <script>
        // å¯ç”¨çš„ä¸»é¢˜åˆ—è¡¨
        const AVAILABLE_THEMES = [
            { id: 'digestive-system', name: 'æ¶ˆåŒ–ç³»çµ±', emoji: 'ğŸ«€' },
            { id: 'plant-transport', name: 'æ¤ç‰©é‹è¼¸', emoji: 'ğŸŒ¿' }
            // æœªæ¥å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šä¸»é¢˜
        ];
        
        let currentViewer = null;
        
        /**
         * åŠ¨æ€åŠ è½½ä¸»é¢˜å¹¶åˆå§‹åŒ–
         */
        function loadTheme(themeId) {
            // éšè—ä¸»é¢˜é€‰æ‹©å™¨
            document.getElementById('theme-selector-panel').classList.remove('visible');
            document.getElementById('theme-switcher-btn').classList.remove('active');
            
            // é”€æ¯æ—§çš„viewer
            if (currentViewer && currentViewer.engine) {
                currentViewer.engine.dispose();
            }
            
            // æ¸…ç©ºå®¹å™¨
            document.getElementById('hotspots-container').innerHTML = '';
            document.getElementById('scene-selector').innerHTML = '';
            document.getElementById('scene-name').textContent = '';
            
            // ç§»é™¤æ—§çš„ä¸»é¢˜è„šæœ¬æ ‡ç­¾
            const oldScripts = document.querySelectorAll('script[data-theme]');
            oldScripts.forEach(script => script.remove());
            
            // æ¸…ç©ºä¸»é¢˜ç›¸å…³çš„å…¨å±€å˜é‡
            const themeVar = themeId.toUpperCase().replace(/-/g, '_') + '_THEME';
            delete window[themeVar];
            
            // åŠ¨æ€åŠ è½½ä¸»é¢˜è„šæœ¬
            const script = document.createElement('script');
            script.src = `themes/${themeId}.js?t=${Date.now()}`; // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
            script.setAttribute('data-theme', themeId); // æ ‡è®°ä¸ºä¸»é¢˜è„šæœ¬
            script.onload = () => {
                // è·å–ä¸»é¢˜é…ç½®
                const themeVar = themeId.toUpperCase().replace(/-/g, '_') + '_THEME';
                const themeConfig = window[themeVar];
                
                if (themeConfig) {
                    // åˆå§‹åŒ–æ–°çš„viewer
                    currentViewer = new VRViewer(themeConfig);
                    currentViewer.init();
                    
                    // æ›´æ–°URLï¼ˆæ–¹ä¾¿åˆ†äº«é“¾æ¥ï¼‰
                    window.history.replaceState({}, '', `?theme=${themeId}`);
                    
                    console.log(`âœ“ å·²åŠ è½½ä¸»é¢˜: ${themeId}`);
                } else {
                    console.error(`ä¸»é¢˜å¸¸é‡ ${themeVar} æœªæ‰¾åˆ°`);
                    console.log('å¯ç”¨çš„å…¨å±€å˜é‡:', Object.keys(window).filter(k => k.includes('THEME')));
                }
            };
            script.onerror = () => {
                console.error(`æ— æ³•åŠ è½½ä¸»é¢˜è„šæœ¬: themes/${themeId}.js`);
            };
            document.head.appendChild(script);
        }
        
        /**
         * åˆå§‹åŒ–ä¸»é¢˜é€‰æ‹©å™¨UI
         */
        function initThemeSelector() {
            const optionsContainer = document.getElementById('theme-options');
            const panel = document.getElementById('theme-selector-panel');
            const switcher = document.getElementById('theme-switcher-btn');
            
            // ç”Ÿæˆä¸»é¢˜é€‰é¡¹æŒ‰é’®
            AVAILABLE_THEMES.forEach(theme => {
                const btn = document.createElement('button');
                btn.className = 'theme-option-btn';
                
                // åˆ›å»ºemojiå’Œæ–‡æœ¬åˆ†å¼€çš„ç»“æ„
                const emojiSpan = document.createElement('span');
                emojiSpan.className = 'emoji';
                emojiSpan.textContent = theme.emoji;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'name';
                nameSpan.textContent = theme.name;
                
                btn.appendChild(emojiSpan);
                btn.appendChild(nameSpan);
                btn.addEventListener('click', () => loadTheme(theme.id));
                optionsContainer.appendChild(btn);
            });
            
            // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
            switcher.addEventListener('click', () => {
                panel.classList.toggle('visible');
                switcher.classList.toggle('active');
            });
            
            // ç‚¹å‡»é¢æ¿å¤–å…³é—­
            document.addEventListener('click', (e) => {
                if (!panel.contains(e.target) && !switcher.contains(e.target)) {
                    panel.classList.remove('visible');
                    switcher.classList.remove('active');
                }
            });
        }
        
        /**
         * é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
         */
        window.addEventListener('DOMContentLoaded', () => {
            initThemeSelector();
            
            // ä»URLå‚æ•°è¯»å–ä¸»é¢˜ï¼Œæˆ–ä½¿ç”¨é»˜è®¤ä¸»é¢˜
            const urlParams = new URLSearchParams(window.location.search);
            const themeId = urlParams.get('theme') || 'digestive-system';
            
            loadTheme(themeId);
        });
    </script>
</body>
</html>
